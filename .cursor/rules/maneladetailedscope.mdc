---
description: 
globs: 
alwaysApply: true
---
# **Manela Platform CMS/LMS Architecture**

## **Project Scope & Purpose**

**Manela** is a B2B2C, multi-tenant platform designed to support companies and their employees across the **entire parental leave journey**, including:

- Preparing for leave
- Managing the leave experience
- Returning to work with support

### Multi-Tenant Features:

- Each **company** gets its own HR admin dashboard.
- Each **employee** gets private access to company-specific tools and content.
- A **Superadmin CMS/LMS** layer governs platform-wide data, roles, analytics, and content.

---

# **SUPERADMINdashboard.tsx**

## **Access & Permissions**

- Full access to all company, HR admin, and employee data.
- Can impersonate any dashboard via:
    - **View-only** (read-only)
    - **Edit mode** (with action logging)
- Can override any onboarding flow or access restriction.
## **Authentication & Invitations**

- Can send magic links to:
    - HR admins
    - Employees (on behalf of companies)
- Handles edge cases:
    - If a user signs up with an **unregistered domain**:
        - A new company is auto-created in a **pending** state.
        - Superadmin must **manually approve** the new company.
- Magic Link Policy:
    - Valid for **30 days**
    - Expired links prompt user to contact support@manela.ca or their company.

## **Audit Logs & Tracking**

- Access to **full platform audit logs**:
    - Actions, timestamps, session duration, page visits, edit trails, etc.
    - HR admin & employee behavior analytics (real-time)
- Tracks:
    - Inactive vs. active users
    - Failed login attempts (max **4 per email**)
    - All impersonation/view-as actions
- Only Superadmins can view audit logs.

## **API & Security**

- Can manage **API keys** per company.
- All Superadmin actions are **logged** and **attributed**.
- Implements **rate limiting** (details TBD).
- Secure role separation: Superadmin > HR Admin > Employee.
- All data interactions must **respect RLS (Row-Level Security)** on Supabase, bypassed only by Superadmin queries.

---

# HR Admins = dashboard.tsx

## **Access & Permissions**

- Can invite additional HR admins (seat-based, managed by Superadmin).
- Cannot view **any employee PII**.
- Can manage employee access:
    - Remove
    - Disable
    - Revoke invites
- Can generate company-specific reports and view integration logs.

## **Authentication & Onboarding**

- Must use a **company domain email** (no personal addresses).
- Can send magic link invites to their employees.
- View analytics limited to their own dashboard and tenant.



---

# **EMPLOYEE**

## **Access & Permissions**

- Can update **personal details** (name, email, etc.):
    - Not visible to HR Admin.
    - Changes are versioned and reversible.
- Can only view tools/content tied to **their company**.
- Cannot be attached to multiple companies.
- Cannot access other companies’ dashboards.

## **Authentication & Onboarding**

- Onboarding includes a **multi-step flow**.
    - Step 1 captures password.
    - Incomplete onboarding triggers **tool restrictions** and a **persistent banner**.
    - Users can resume onboarding at any time.
- Access is gated until onboarding is complete.

---

# **Shared Functionality & System Behavior**

## **Magic Links**

- Valid for 30 days.
- Expired links prompt users to:
    - Request a new one from their HR admin
    - Contact support@manela.ca
- Signing up with unrecognized domains:
    - Auto-generates a **pending company**
    - Triggers email to support for Superadmin review

## **Session & Event Tracking**

- Superadmindashboard.tsx Tracks:
    - Session duration
    - Navigation events
    - Clicks and form submissions
- Supports scaling to **thousands of concurrent users**.
- Logged events include type + metadata for analytics.

## **User Deactivation & Inactivity**

- Users marked inactive after **X days** (TBD).
- Inactive users tracked separately in analytics.
- Reactivation:
    - Can be triggered by Superadmin or HR Admin.
- Locked out users see a message prompting:
    - Contact with HR admin
    - Support escalation

## **Reporting & Analytics**

- **Superadmin** can access platform-wide metrics:
    - Usage, leaves, engagement, user trends
- **HR Admins** get scoped reporting only.
- Includes:
    - Blog/article views
    - Tool usage
    - Session and page analytics

---

# **Development Best Practices (Supabase & PostgreSQL)**

### General Development Rules

- **Always write Supabase code in PostgreSQL syntax**
- **Always reference the current schema** before making table edits
- **Always check** that a column/field exists before editing
- **Create fields if they don’t exist**, with schema updates documented
- **Avoid destructive changes** unless required — explain clearly why if so
- **Never assume a field exists** — always validate before referencing
- Always check that database is up to date before making changes

---

# **Architecture: Superadmin Dashboard**

### `superadmindashboard.tsx`

- Central hub for platform-wide data and control
- Operates separately from `main.tsx` and `dashboard.tsx`
- Connects to Supabase to pull data from:
    - User events
    - Tenant actions
    - CMS content per company
- Controls global LMS structure
- Built with:
    - Segregated navigation and analytics panels
